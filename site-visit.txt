CREATE TABLE site_visits (
    site_visit_id     UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    visit_date        DATE NOT NULL,
    user_id           UUID NOT NULL,   -- agent who did the visit
    project_id        UUID NOT NULL,
    vehicle_type      VARCHAR(50),
    expense_amount    NUMERIC(12,2) NOT NULL DEFAULT 0,
    remarks           TEXT,
    status            VARCHAR(20) NOT NULL DEFAULT 'OPEN',
    created_at        TIMESTAMP NOT NULL DEFAULT now(),
    updated_at        TIMESTAMP NOT NULL DEFAULT now(),
    CONSTRAINT fk_sv_user FOREIGN KEY (user_id) REFERENCES app_users(user_id),
    CONSTRAINT fk_sv_project FOREIGN KEY (project_id) REFERENCES projects(project_id)
);


CREATE TABLE site_visit_customers (
    site_visit_id UUID NOT NULL,
    customer_id   UUID NOT NULL,
    PRIMARY KEY (site_visit_id, customer_id),
    CONSTRAINT fk_svc_site_visit FOREIGN KEY (site_visit_id) REFERENCES site_visits(site_visit_id) ON DELETE CASCADE,
    CONSTRAINT fk_svc_customer FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
);


CREATE TABLE site_visit_payments (
    payment_id     UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    site_visit_id  UUID NOT NULL,
    user_id        UUID NOT NULL,   -- payee (agent / stakeholder)
    amount         NUMERIC(12,2) NOT NULL,
    payment_mode   VARCHAR(20) NOT NULL,   -- CASH / UPI / BANK
    payment_date   DATE NOT NULL DEFAULT CURRENT_DATE,
    remarks        TEXT,
    created_at     TIMESTAMP NOT NULL DEFAULT now(),
    CONSTRAINT fk_svp_site_visit FOREIGN KEY (site_visit_id) REFERENCES site_visits(site_visit_id) ON DELETE CASCADE,
    CONSTRAINT fk_svp_user FOREIGN KEY (user_id) REFERENCES app_users(user_id)
);


CREATE TABLE site_visit_accounts (
    site_visit_id UUID PRIMARY KEY,
    total_paid    NUMERIC(12,2) NOT NULL DEFAULT 0,
    balance       NUMERIC(12,2) NOT NULL DEFAULT 0,
    status        VARCHAR(20) NOT NULL DEFAULT 'OPEN',
    CONSTRAINT fk_sva_site_visit FOREIGN KEY (site_visit_id) REFERENCES site_visits(site_visit_id) ON DELETE CASCADE
);


CREATE INDEX idx_site_visits_visit_date ON site_visits(visit_date);
CREATE INDEX idx_site_visits_agent ON site_visits(user_id);
CREATE INDEX idx_site_visits_project ON site_visits(project_id);

CREATE INDEX idx_expenses_site_visit ON site_visit_expenses(site_visit_id);
CREATE INDEX idx_payments_site_visit ON site_visit_payments(site_visit_id);
CREATE INDEX idx_sv_agent_date ON site_visits (user_id, visit_date);

CREATE INDEX idx_sv_project_date ON site_visits (project_id, visit_date);

CREATE INDEX idx_sv_visit_date ON site_visits (visit_date);

CREATE TABLE notification_log (
    id BIGSERIAL PRIMARY KEY,
    event_id VARCHAR(50),
    event_type VARCHAR(50),
    channel VARCHAR(20),
    recipient VARCHAR(100),
	title VARCHAR(120),
    message TEXT,
    status VARCHAR(20),
    failure_reason TEXT,
	read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

alter table user_auth add column mobile VARCHAR(120);

UPDATE user_auth ua
SET mobile = au.mobile
FROM app_users au
WHERE ua.user_id = au.user_id;

UPDATE user_auth ua
SET mobile = au.mobile
FROM customers au
WHERE ua.user_id = au.customer_id;

CREATE TABLE notifications (
    notification_id     BIGSERIAL PRIMARY KEY,
    user_id             UUID NOT NULL,
    title               VARCHAR(255) NOT NULL,
    message             TEXT NOT NULL,
    channel VARCHAR(20) NOT NULL, -- PUSH, EMAIL, SMS
    status VARCHAR(20) DEFAULT 'PENDING', -- SENT, FAILED
    event_type VARCHAR(50),        -- LEAD_CREATED, DEAL_CLOSED
    event_id UUID,        -- leadId, dealId, etc
    redirect_url VARCHAR(255),
    read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT now()
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_unread ON notifications(user_id, is_read);

CREATE TABLE user_devices (
    device_id       BIGSERIAL PRIMARY KEY,
    user_id         UUID NOT NULL,

    device_token    TEXT NOT NULL,
    platform        VARCHAR(20) NOT NULL, -- WEB, ANDROID, IOS

    active          BOOLEAN DEFAULT TRUE,

    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_used_at    TIMESTAMP
);

CREATE UNIQUE INDEX uk_device_token ON user_devices(device_token);
CREATE INDEX idx_user_devices_user ON user_devices(user_id);

CREATE TABLE notification_preferences (
    preference_id   BIGSERIAL PRIMARY KEY,
    user_id         UUID NOT NULL,

    notification_type VARCHAR(50),
    push_enabled    BOOLEAN DEFAULT TRUE,
    email_enabled   BOOLEAN DEFAULT FALSE,
    sms_enabled     BOOLEAN DEFAULT FALSE
);

CREATE TABLE leads (
    id BIGSERIAL PRIMARY KEY,
    property_id UUID NOT NULL,
    customer_id UUID NOT NULL,
    name VARCHAR(150),
    phone VARCHAR(20),
    email VARCHAR(150),
    source VARCHAR(50),
    status VARCHAR(30) DEFAULT 'NEW',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_leads_owner_id ON leads(owner_id);
CREATE INDEX idx_leads_property_id ON leads(property_id);


CREATE TABLE lead_stakeholders (
    lead_id BIGINT NOT NULL,
    user_id BIGINT UUID NULL,
    role VARCHAR(50),  -- OWNER, AGENT, ADMIN
    PRIMARY KEY (lead_id, user_id)
);

CREATE INDEX idx_lead_stakeholders_user ON lead_stakeholders(user_id);
